<!DOCTYPE html>
<html>
  <head>
    <title>Reimplementing the Coreutils in a modern language</title>
    <meta charset="utf-8">
    <style>
      @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
      @import url(https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

      body { font-family: 'Droid Serif'; }
      h1, h2, h3 {
        font-family: 'Yanone Kaffeesatz';
        font-weight: normal;
      }
      .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }
    </style>
  </head>
  <body>
    <textarea id="source">

class: center, middle

# Reimplementing the Coreutils in a modern language

## (Rust, not C++)

---

# Who am I ?

Debian developer, LLVM/Clang contributor, and other things.

Director at Mozilla (but this work is unrelated).

And been managing some

<img src="Rust_programming_language_black_logo.svg" width="300"/>

developers but also worked next to Rust core developers.

---

# Who am I ? (bis)

I also uploaded the initial version of Rustc in Debian/Ubuntu.
---

# Early 2022

TODO insert image press covid

---

# Started with

TODO insert lego

---

# How to make the best use this time?

---

# Some people made

TODO insert image pain

---

# Other did

TODO insert image jardin

---

Continue with

TODO insert buffy

---

Continue with

TODO insert BBT

---

# Me?

I want to learn Rust for real with an impactful project.

---

# Clang & Debian

TODO inject image of clang.debian.net



---

# Rust ?

How can I replicate something similar with Rust?

---

# Rust ?

How can I replicate something similar with Rust?

## glibc ?

Too hard

---

# Rust ?

How can I replicate something similar with Rust?

## glibc ?

Too hard

## Linux kernel, clang, llvm ?

Way too hard

---

# What about the Coreutils ?

I have always been curious to see how it works.

Even if I am terrible with ASM...

---

# What about the Coreutils ?

I have always been curious to see how it works.

Even if I am terrible with ASM...

## Good news

There is almost no ASM in the GNU/coreutils (besides a few lines in src/longlong.h).

---

# What the point ?

Well, it is a good question

---

# What the point ?
TODO - split

Well, it is a good question

1. Why not?

2. Rust rocks.

3. It is NOT about security<br />
https://security-tracker.debian.org/tracker/source-package/coreutils<br />
Only 17 CVE in GNU/Coreutils since 2003

4. It is NOT about license (for me at least).<br />
Not interested by the MIT vs GPL debate.

5. It is very interesting.


---

# You keep on talking about the coreutils<br />but what is it?

---

# You keep on talking about the coreutils<br />but what is it?

Who was born after 2000 ?

---

# You keep on talking about the coreutils<br />but what is it?

Who was born after 2000 ?

Who was born after 1990 ?
---

# You keep on talking about the coreutils<br />but what is it?

Who was born after 2000 ?

Who was born after 1990 ?

Who was born after 1980 ?
---

# You keep on talking about the coreutils<br />but what is it?

Who was born after 2000 ?

Who was born after 1990 ?

Who was born after 1980 ?

Who was born after 1971 ?
---

# You keep on talking about the coreutils<br />but what is it?

Who was born after 2000 ?

Who was born after 1990 ?

Who was born after 1980 ?

Who was born after 1971 ?

<b>Congratulations, you are younger than the initial implementation</b>

---

# First version

UNIX: PDP-7<br />
Author: Ken Thompson <ken@research.uucp> <br />
Date:   Tue Jun 30 05:00:00 1970 -0500

We can find:
* chmod.s
* chown.s
* cp.s
* ...
 
https://archive.softwareheritage.org/browse/origin/directory/?branch=refs/heads/Research-PDP7-Snapshot-Development&origin_url=https://github.com/dspinellis/unix-history-repo

---

# 'New' version in C

Research Unix - first versions<br />
More on https://en.wikipedia.org/wiki/Research_Unix


Author: Ken Thompson <ken@research.uucp><br />
Date:   Tue Nov 21 14:35:16 1972 -0500<br />
Co-Authored-By: Dennis Ritchie <dmr@research.uucp><br />

Mix of ASM (ex: ls.s, ln.s, etc) & C (cp.c, if.c, etc)

---

# 'New' version in C

Example of code - CLI implementation

```c
// usr/source/s1/chmod.c
        for(m=0; *c; c++) {
                if(*c < '0' || *c > '7') {
                        printf("bad mode\n");
                        exit(1);
                }
                m = (m<<3) | *c - '0';
        }
        for(i=2; i<argc; i++)
                if(chmod(argv[i], m) < 0) {
                        count++;
                        perror(argv[i]);
                }
```

---

# 'New' version in C

Example of code - chmod function implementation

```c
// usr/sys/ken/sys4.c
chmod()
{
        register *ip;

        if ((ip = owner()) == NULL)
                return;
        ip->i_mode =& ~07777;
        if (u.u_uid)
                u.u_arg[1] =& ~ISVTX;
        ip->i_mode =| u.u_arg[1]&07777;
        ip->i_flag =| IUPD;
        iput(ip);
}
```

---

# Fast forward to 2023

About 105 commands in the GNU implementation.

```bash
arch      cut        fold      mkfifo   printenv  split     tsort
base32    date       groups    mknod    printf    stat      tty
base64    dd         hashsum   mktemp   ptx       stdbuf    uname
basename  df         head      more     pwd       stty      unexpand
basenc    dir        hostid    mv       readlink  sum       uniq
cat       dircolors  hostname  nice     realpath  sync      unlink
chcon     dirname    id        nl       relpath   tac       uptime
chgrp     du         install   nohup    rm        tail      users
chmod     echo       join      nproc    rmdir     tee       vdir
chown     env        kill      numfmt   runcon    test      wc
chroot    expand     link      od       seq       timeout   who
cksum     expr       ln        paste    shred     touch     whoami
comm      factor     logname   pathchk  shuf      tr        yes
cp        false      ls        pinky    sleep     true
csplit    fmt        mkdir     pr       sort      truncate
```
---
# Quick quizz

Who knows about ...
---
# Quick quizz

Who knows about ...

* cp/mv/rm/mkdir
---
# Quick quizz

Who knows about ...
* cp/mv/rm/mkdir
* chown/chmod/chgrp

---
# Quick quizz

Who knows about ...
* cp/mv/rm/mkdir
* chown/chmod/chgrp
* numfmt

---
# Quick quizz

Who knows about ...
* cp/mv/rm/mkdir
* chown/chmod/chgrp
* numfmt
```bash
  echo 1.18GB|coreutils  numfmt --from=si --suffix=B
  1180000000B
```

---
# Quick quizz

Who knows about ...
* cp/mv/rm/mkdir
* chown/chmod/chgrp
* numfmt
* pr

---
# Quick quizz

Who knows about ...
* cp/mv/rm/mkdir
* chown/chmod/chgrp
* numfmt
* pr
```
  convert text files for printing
```

---
# Quick quizz

Who knows about ...
* cp/mv/rm/mkdir
* chown/chmod/chgrp
* numfmt
* pr
* csplit

---
# Quick quizz

Who knows about ...
* cp/mv/rm/mkdir
* chown/chmod/chgrp
* numfmt
* pr
* csplit
```
  split a file into sections determined by context lines
```

---
# Quick quizz

Who knows about ...
* cp/mv/rm/mkdir
* chown/chmod/chgrp
* numfmt
* pr
* csplit
* and others like piny, tsort, shuf, shred, seq, etc

---

# Example with `cp` and other commands


```bash
$ cp --help    | grep "  -" | wc -l
34
$ chown --help | grep "  -" | wc -l
15
$ ln --help    | grep "  -" | wc -l
16
```
---

# A bunch of different implementations

* GNU's coreutils
* BSD
* Busybox
* Toybox (Android)
* V lang implemen https://github.com/vlang/coreutils
* ... ??? (if you know, please sylvestre@debian.org)


---

# Now, Rust implementation?

* Started by Jordi Boggiano in 2013 (yeah, before Rust 1.0)
* Found it, saw that some maintainers were still around helping
* Started to contribute in April 2020 and quickly took over
* Replicate the success of clang - dropped in replacement

---
# Goals?

* My goals have been:
  - Be able to boot Debian
  - Install the top 1000 packages
  - Build Firefox, LLVM and the Linux Kernel
  - Package it for Debian & Ubuntu

---
# Goals?

For this, we had to deploy:
* Proper CI (and therefore build system)
* Add code coverage support
* Improve the code coverage results (ie write plenty of tests)
* Plug clippy and rustfmt


Took about a year to be in that state

---

TODO add graph

---

# Biggest finding

It is mostly a wrapper on top of the libc


---



---


# What is next?

* Implement missing options
* Complete the full compatibility with the GNU tools
* Improve performances on some key programs


---

# Introduction

    </textarea>
    <script src="https://remarkjs.com/downloads/remark-latest.min.js">
    </script>
    <script>
      var slideshow = remark.create();
    </script>
  </body>
</html>
